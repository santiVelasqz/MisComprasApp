<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supermercados | Marvel's Shop</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <!-- CSS personalizado -->
    <link href="/css/style.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <!-- Hero -->
    <section class="hero" style="background-image: linear-gradient(rgba(44,181,190,0.6), rgba(44,181,190,0.6)), url('https://source.unsplash.com/1600x600/?supermarket,store');">
        <h1>Supermercados</h1>
        <p>Gestiona y explora todos tus supermercados registrados</p>
    </section>

	<div class="container my-5">
		<!-- Buscador -->
		<form class="row g-3 mb-4">
			<div class="col-md-6">
				<input type="text" class="form-control" id="searchInput"
					placeholder="Buscar supermercados...">
			</div>
		</form>

		<!-- Tabla -->
		<div class="table-responsive shadow rounded">
			<table id="supermercadoTable" class="table-modern">
				<thead>
					<tr>
						<th>ID</th>
						<th>Nombre</th>
						<th>Ciudad</th>
						<th>Productos</th>
						<th>Modificar</th>
						<th>Eliminar</th>
					</tr>
				</thead>
				<tbody>
    <tr th:each="supermercado : ${supermercados}"
        th:attr="data-no-borrable=${supermercadosNoBorrables[supermercado.id]}">
        <td th:text="${supermercado.id}"></td>
        <td th:text="${supermercado.nombre}"></td>
        <td th:text="${supermercado.ciudad}"></td>
        <td>
            <a class="btn btn-sm btn-view"
               th:href="@{'/supermercado/' + ${supermercado.id} + '/productos'}">
               <i class="bi bi-box-seam"></i> Ver productos
            </a>
        </td>
        <td>
            <a class="btn btn-sm btn-edit btn-check-compras"
               th:href="@{'/modificar-supermercado/' + ${supermercado.id}}">
               <i class="bi bi-pencil"></i> Editar
            </a>
        </td>
        <td>
            <a class="btn btn-sm btn-delete btn-check-compras"
               th:href="@{'/borrar-supermercado/' + ${supermercado.id}}">
               <i class="bi bi-trash"></i> Borrar
            </a>
        </td>
    </tr>

    <tr th:if="${#lists.isEmpty(supermercados)}">
        <td colspan="6" class="text-center">No hay supermercados registrados</td>
    </tr>
</tbody>
			</table>
		</div>
	</div>

	<!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- Script búsqueda AJAX -->
        <!-- Script búsqueda AJAX -->
    <script>
    function engancharEventosBorrar() {
        document.querySelectorAll(".btn-check-compras").forEach(function(boton) {
            boton.addEventListener("click", function(e) {
                const fila = boton.closest("tr");
                const noBorrable = fila.getAttribute("data-no-borrable") === "true";

                if (noBorrable) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'warning',
                        title: 'Acción no permitida',
                        text: '⚠️ No puedes modificar o eliminar este supermercado porque tiene compras o productos asociados.',
                        confirmButtonColor: '#2CB5BE',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }

                if (boton.classList.contains('btn-delete')) {
                    e.preventDefault();
                    const url = boton.getAttribute('href');
                    Swal.fire({
                        title: '¿Estás seguro?',
                        text: "Esta acción no se puede deshacer.",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Sí, borrar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = url;
                        }
                    });
                }
            });
        });
    }

    $(document).ready(function () {
        $('#searchInput').on('input', function () {
            var searchTerm = $(this).val();
            $.ajax({
                url: '/search-supermercado',
                data: { nombre: searchTerm },
                success: function (supermercados) {
                    var tableBody = $('#supermercadoTable tbody');
                    tableBody.empty();

                    if (supermercados.length === 0) {
                        tableBody.append('<tr><td colspan="6" class="text-center">No hay datos</td></tr>');
                    } else {
                        $.each(supermercados, function (i, s) {
                            var fila = '<tr data-no-borrable="' + s.noBorrable + '">' +
                                '<td>' + s.id + '</td>' +
                                '<td>' + s.nombre + '</td>' +
                                '<td>' + s.ciudad + '</td>' +
                                '<td><a class="btn btn-sm btn-view" href="/supermercado/' + s.id + '/productos"><i class="bi bi-box-seam"></i> Ver productos</a></td>' +
                                '<td><a class="btn btn-sm btn-edit btn-check-compras" href="/modificar-supermercado/' + s.id + '"><i class="bi bi-pencil"></i> Editar</a></td>' +
                                '<td><a class="btn btn-sm btn-delete btn-check-compras" href="/borrar-supermercado/' + s.id + '"><i class="bi bi-trash"></i> Borrar</a></td>' +
                                '</tr>';
                            tableBody.append(fila);
                        });

                        // Volver a enganchar eventos
                        engancharEventosBorrar();
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error en la búsqueda:", error);
                }
            });
        });

        // Enganchar eventos inicial para la primera carga
        engancharEventosBorrar();
    });
</script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
