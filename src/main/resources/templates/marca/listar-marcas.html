<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcas | Marvel's Shop</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <!-- CSS personalizado -->
    <link href="/css/style.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
</head>
<body>

    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <!-- Hero -->
    <section class="hero" style="background-image: linear-gradient(rgba(44, 181, 190, 0.6), rgba(44, 181, 190, 0.6)), url('https://source.unsplash.com/1600x600/?brand,shopping');">
        <h1>Marcas</h1>
        <p>Administra y organiza tus marcas de manera sencilla</p>
    </section>

	<div class="container my-5">
		<!-- Búsqueda -->
		<form class="row g-3 mb-4">
			<div class="col-md-6">
				<input type="text" class="form-control" id="searchInput"
					placeholder="Buscar marca...">
			</div>
		</form>
		<!-- Tabla -->
		<div class="table-responsive shadow rounded">
			<table id="marcaTable" class="table-modern">
				<thead>
					<tr>
						<th>ID</th>
						<th>Nombre</th>
						<th>Modificar</th>
						<th>Eliminar</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="marca : ${marcas}"
						th:attr="data-tiene-productos=${marcasConProductos[marca.id]}">
						<td th:text="${marca.id}"></td>
						<td th:text="${marca.nombre}"></td>
						<td><a class="btn btn-sm btn-edit btn-check-compras"
							th:href="@{'/modificar-marca/' + ${marca.id}}"> <i
								class="bi bi-pencil"></i> Editar
						</a></td>
						<td><a class="btn btn-sm btn-delete btn-check-compras"
							th:href="@{'/borrar-marca/' + ${marca.id}}"> <i
								class="bi bi-trash"></i> Borrar
						</a></td>
					</tr>
					<tr th:if="${#lists.isEmpty(marcas)}">
                        <td colspan="4" class="text-center">No hay marcas registradas</td>
                    </tr>
				</tbody>
			</table>
		</div>
	</div>

	<!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- Script búsqueda AJAX -->
  <script>
  function engancharEventosBorrar() {
	    // Mostrar SweetAlert si hay mensaje de éxito
	    const mensajeSuccessDiv = document.getElementById('mensajeSuccess');
	    if (mensajeSuccessDiv && mensajeSuccessDiv.textContent.trim() !== "") {
	        Swal.fire({
	            icon: 'success',
	            title: '¡Éxito!',
	            text: mensajeSuccessDiv.textContent.trim(),
	            confirmButtonColor: '#2cb5be',
	            confirmButtonText: 'Aceptar'
	        });
	    }

	    // Primero remueve handlers anteriores para evitar múltiples ejecuciones
	    document.querySelectorAll(".btn-check-compras").forEach(function(boton) {
	        boton.onclick = null;

	        boton.addEventListener("click", function(e) {
	            e.preventDefault();

	            const fila = boton.closest("tr");
	            const tieneProductos = fila.getAttribute("data-tiene-productos") === "true";

	            if (tieneProductos) {
	                Swal.fire({
	                    icon: 'warning',
	                    title: 'No se puede borrar',
	                    text: 'Esta marca tiene productos asociados y no se puede eliminar.',
	                    confirmButtonText: 'Entendido',
	                    confirmButtonColor: '#2cb5be'
	                });
	                return;
	            }

	            const url = boton.getAttribute("href");

	            Swal.fire({
	                title: '¿Estás seguro?',
	                text: "Esta acción no se puede deshacer.",
	                icon: 'warning',
	                showCancelButton: true,
	                confirmButtonColor: '#d33',
	                cancelButtonColor: '#3085d6',
	                confirmButtonText: 'Sí, borrar',
	                cancelButtonText: 'Cancelar'
	            }).then((result) => {
	                if (result.isConfirmed) {
	                    window.location.href = url;
	                }
	            });
	        });
	    });
	}

	$(document).ready(function() {
	    // Engancha eventos iniciales
	    engancharEventosBorrar();

	    // Búsqueda AJAX
	    $('#searchInput').on('input', function() {
	        var searchTerm = $(this).val();
	        $.ajax({
	            url: '/search-marca',
	            data: { nombre: searchTerm },
	            success: function(marcas) {
	                var tableBody = $('#marcaTable tbody');
	                tableBody.empty();

	                if (marcas.length === 0) {
	                    tableBody.append('<tr><td colspan="4" class="text-center">No hay marcas registradas</td></tr>');
	                } else {
	                    $.each(marcas, function(i, marca) {
	                        var tieneProductos = marca.tieneProductos ? 'true' : 'false';
	                        var row = '<tr data-tiene-productos="' + tieneProductos + '">' +
	                            '<td>' + marca.id + '</td>' +
	                            '<td>' + marca.nombre + '</td>' +
	                            '<td><a class="btn btn-sm btn-edit btn-check-compras" href="/modificar-marca/' + marca.id + '"><i class="bi bi-pencil"></i> Editar</a></td>' +
	                            '<td><a class="btn btn-sm btn-delete btn-check-compras" href="/borrar-marca/' + marca.id + '"><i class="bi bi-trash"></i> Borrar</a></td>' +
	                            '</tr>';
	                        tableBody.append(row);
	                    });
	                }

	                // Reenganchar eventos a botones nuevos creados con AJAX
	                engancharEventosBorrar();
	            },
	            error: function(xhr, status, error) {
	                console.error("Error en la búsqueda:", error);
	            }
	        });
	    });
	});

</script>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
