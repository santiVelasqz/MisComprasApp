<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras en Supermercados | Marvel's Shop</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <!-- CSS personalizado -->
    <link href="/css/style.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <!-- Hero -->
    <section class="hero" style="background-image: linear-gradient(rgba(44,181,190,0.6), rgba(44,181,190,0.6)), url('https://source.unsplash.com/1600x600/?supermarket,shopping');">
        <h1>Compras en Supermercados</h1>
        <p>Consulta, filtra y gestiona tus compras con facilidad</p>
    </section>

   <div class="container my-5">

    <!-- Campo de búsqueda global -->
    <form class="row g-3 mb-4">
        <div class="col-md-6">
            <input type="text" class="form-control" id="searchCompraInput" placeholder="Buscar compra...">
        </div>
    </form>

    <!-- Opciones de búsqueda -->
    <div class="row g-4 mb-5">

        <!-- Buscar por fecha -->
        <div class="col-lg-4 col-md-6">
            <div class="card p-3 shadow-sm">
                <h5 class="text-center mb-3"><i class="bi bi-calendar-date"></i> Buscar por fecha</h5>
                <form th:action="@{/compras-fecha}" method="get">
                    <input type="date" name="fecha" class="form-control mb-3" required>
                    <button type="submit" class="btn btn-search w-100">Buscar</button>
                </form>
            </div>
        </div>

        <!-- Buscar por año -->
        <div class="col-lg-4 col-md-6">
            <div class="card p-3 shadow-sm">
                <h5 class="text-center mb-3"><i class="bi bi-calendar"></i> Buscar por año</h5>
                <form th:action="@{/compras-anio}" method="get">
                    <input type="number" min="2000" max="2100" name="anio" class="form-control mb-3" required />
                    <button type="submit" class="btn btn-search w-100">Buscar</button>
                </form>
            </div>
        </div>

        <!-- Buscar por supermercado -->
        <div class="col-lg-4 col-md-6">
            <div class="card p-3 shadow-sm">
                <h5 class="text-center mb-3"><i class="bi bi-shop"></i> Buscar por supermercado</h5>
                <form th:action="@{/compras-supermercado}" method="get">
                    <select name="supermercado" class="form-control mb-3" required>
                        <option th:each="supermercado : ${supermercados}"
                                th:value="${supermercado.id}"
                                th:text="${supermercado.nombre + ' (' + (supermercado.ciudad != null ? supermercado.ciudad : 'Sin ciudad') + ')'}">
                        </option>
                    </select>
                    <button type="submit" class="btn btn-search w-100">Buscar</button>
                </form>
            </div>
        </div>

        <!-- Rango de fechas -->
        <div class="col-lg-4 col-md-6">
            <div class="card p-3 shadow-sm">
                <h5 class="text-center mb-3"><i class="bi bi-calendar-range"></i> Rango de fechas</h5>
                <form th:action="@{/compras-rango-fecha}" method="get">
                    <input type="date" name="fecha1" class="form-control mb-2" required>
                    <input type="date" name="fecha2" class="form-control mb-3" required>
                    <button type="submit" class="btn btn-search w-100">Buscar</button>
                </form>
            </div>
        </div>

        <!-- Mes y año -->
        <div class="col-lg-4 col-md-6">
            <div class="card p-3 shadow-sm">
                <h5 class="text-center mb-3"><i class="bi bi-calendar-month"></i> Mes y año</h5>
                <form th:action="@{/compras-mes}" method="get">
                    <select name="mes" class="form-control mb-2">
                        <option th:each="m : ${T(com.smarvel.springboot.backend.enums.Mes).values()}"
                                th:value="${m}" th:text="${m.name()}"></option>
                    </select>
                    <input type="number" name="anio" class="form-control mb-3" required />
                    <button type="submit" class="btn btn-search w-100">Buscar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Tabla de compras -->
    <div class="table-responsive">
        <table id="compraTable" class="table-modern">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Supermercado</th>
                    <th>Precio venta</th>
                    <th>Cantidad</th>
                    <th>Precio pagado</th>
                    <th>Fecha</th>
                    <th>Modificar</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody>
    <tr th:each="compra : ${compras}">
        
        <!-- Producto -->
        <td th:text="${compra.precioProducto != null 
                        && compra.precioProducto.productoSupermercado != null
                        && compra.precioProducto.productoSupermercado.producto != null 
                        ? compra.precioProducto.productoSupermercado.producto.nombre 
                        : 'Sin producto'}">
        </td>
        
        <!-- Supermercado -->
        <td th:text="${compra.precioProducto != null 
                        && compra.precioProducto.productoSupermercado != null
                        && compra.precioProducto.productoSupermercado.supermercado != null
                        ? compra.precioProducto.productoSupermercado.supermercado.nombre + 
                          ' (' + (compra.precioProducto.productoSupermercado.supermercado.ciudad != null 
                                ? compra.precioProducto.productoSupermercado.supermercado.ciudad 
                                : 'Sin ciudad') + ')'
                        : 'No hay supermercado'}">
        </td>
        <!-- Precio unitario -->
        <td th:text="${#numbers.formatDecimal(compra.precioProducto.precio, 1, 'COMMA', 2, 'POINT')} + ' €'"></td>

        <!-- Cantidad -->
        <td th:text="${compra.cantidad}"></td>

        <!-- Precio pagado -->
        <td th:text="${#numbers.formatDecimal(compra.precioPagado, 1, 'COMMA', 2, 'POINT')} + ' €'"></td>

        <!-- Fecha -->
        <td th:text="${#temporals.format(compra.fechaCompra, 'dd/MM/yyyy')}"></td>

        <!-- Modificar -->
        <td>
            <a class="btn btn-sm btn-edit" th:href="@{/modificar-compra/{id}(id=${compra.id}, origen='general')}">
                <i class="bi bi-pencil"></i> Editar
            </a>
        </td>

        <!-- Eliminar -->
        <td>
            <a class="btn btn-sm btn-delete" th:href="@{'/borrar-compra/' + ${compra.id}}">
                <i class="bi bi-trash"></i> Borrar
            </a>
        </td>
    </tr>

    <!-- Si no hay compras -->
    <tr th:if="${#lists.isEmpty(compras)}">
        <td colspan="8" class="text-center">No hay compras registradas</td>
    </tr>
</tbody>
        </table>
    </div>
</div>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Script búsqueda AJAX adaptado -->
<script>
    $(document).ready(function() {
        $('#searchCompraInput').on('input', function() {
            var searchTerm = $(this).val();
            $.ajax({
                url: '/search-compra',
                data: { search: searchTerm },
                success: function(compras) {
                    var tableBody = $('#compraTable tbody');
                    tableBody.empty();

                    if (compras.length === 0) {
                        tableBody.append('<tr><td colspan="7" class="text-center">No hay compras registradas</td></tr>');
                    } else {
                        $.each(compras, function(i, compra) {
                        	var producto = compra.precioProducto 
                            && compra.precioProducto.productoSupermercado 
                            && compra.precioProducto.productoSupermercado.producto
                            ? compra.precioProducto.productoSupermercado.producto.nombre
                            : 'Sin producto';

                        var supermercado = 'No hay supermercado';
                        if (compra.precioProducto 
                            && compra.precioProducto.productoSupermercado 
                            && compra.precioProducto.productoSupermercado.supermercado) {
                            var ciudad = compra.precioProducto.productoSupermercado.supermercado.ciudad
                                ? compra.precioProducto.productoSupermercado.supermercado.ciudad
                                : 'Sin ciudad';
                            supermercado = compra.precioProducto.productoSupermercado.supermercado.nombre + ' (' + ciudad + ')';
                        }


                            var row = '<tr>'
                                + '<td>' + producto + '</td>'
                                + '<td>' + supermercado + '</td>'
                                + '<td>' + (compra.cantidad != null ? compra.cantidad : '') + '</td>'
                                + '<td>' + (compra.precio != null ? compra.precio : '') + '</td>'
                                + '<td>' + (compra.fecha != null ? compra.fecha : '') + '</td>'
                                + '<td><a class="btn btn-sm btn-primary" href="/modificar-compra/' + compra.id +'?origen=filtros"><i class="bi bi-pencil"></i> Editar</a></td>'
                                + '<td><a class="btn btn-sm btn-danger" href="/borrar-compra/' + compra.id + '"><i class="bi bi-trash"></i> Borrar</a></td>'
                                + '</tr>';
                            tableBody.append(row);
                        });
                    }
                },
                error: function() {
                    console.error("Error en la búsqueda");
                }
            });
        });
    });
</script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
