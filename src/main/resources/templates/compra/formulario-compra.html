<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${compra.id == null ? 'Registrar compra' : 'Editar compra'} + ' | Marvel\'s Shop'"></title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- CSS personalizado -->
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>

    <!-- Navbar -->
    <div th:replace="fragments/navbar :: navbar"></div>

   <!-- Hero dinámico -->
<section class="hero" style="background-image:linear-gradient(rgba(44,181,190,0.6), rgba(44,181,190,0.6)), url('https://source.unsplash.com/1600x500/?shopping,cart');">
    <h1 th:text="${compra != null and compra.id != null ? 'Editar Compra' : 'Registrar Compra'}"></h1>
    <p th:text="${compra != null and compra.id != null ? 'Modifica los detalles de tu compra' : 'Añade una nueva compra a tu registro'}"></p>
</section>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-9">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">

                    <!-- Mensajes flash -->
                    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
                    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

                    <form th:action="@{/guardar-compra}" th:object="${compra}" method="post">
                        <!-- ID oculto -->
                        <input type="hidden" th:field="*{id}" />
                        <input type="hidden" name="origen" th:value="${origen}" />
                        <p>Precio Unitario inicial: <span th:text="${precioUnitario}"></span></p>
<p>Precio Total inicial: <span th:text="${precioTotal}"></span></p>
                        

                        <!-- Producto -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Producto:</label>
                            <select id="productoSelect" th:field="*{precioProducto.productoSupermercado.producto.id}" class="form-control select2" required>
                                <option th:each="producto : ${productos}"
                                        th:value="${producto.id}"
                                        th:text="${producto.nombre + ' (' + (producto.marca != null ? producto.marca.nombre : 'Sin marca') + ')'}">
                                </option>
                            </select>
                        </div>

                        <!-- Supermercado -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Supermercado:</label>
                            <select id="supermercadoSelect" th:field="*{precioProducto.productoSupermercado.supermercado.id}" class="form-control select2" required>
                                <option th:each="supermercado : ${supermercados}"
                                        th:value="${supermercado.id}"
                                        th:text="${supermercado.nombre + ' (' + (supermercado.ciudad != null ? supermercado.ciudad : 'Sin ciudad') + ')'}">
                                </option>
                            </select>
                        </div>

                        <!-- Precio existente -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Precio disponible:</label>
                            <select id="precioSelect" name="productoSupermercadoId" class="form-control select2">
                                <option value="">Selecciona un precio</option>
                                <option value="manual">Otro precio...</option>
                            </select>

                            <!-- Campo para precio manual -->
                            <input type="number" id="precioManual" name="precioManual"
                                    class="form-control mt-2" step="0.01" min="0"
                                    placeholder="Introduce precio manual" style="display:none;">
                        </div>

                        <!-- Campo oculto para enviar el precio unitario cuando se elige de la lista -->
                        <input type="hidden" id="precioUnitarioHidden" name="precioUnitarioSeleccionado" />

                        <!-- Cantidad -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Cantidad:</label>
                            <input type="number" th:field="*{cantidad}" id="cantidadInput" class="form-control" min="1" required>
                        </div>

                        <!-- Precio total -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Precio total:</label>
                            <input type="number" th:field="*{precioPagado}" id="precioInput" class="form-control" min="0" step="0.01" readonly>
                        </div>

                        <!-- Fecha -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Fecha:</label>
                            <input type="date" th:field="*{fechaCompra}" class="form-control" required>
                        </div>

                        <!-- Botón -->
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-search">
                                <i class="bi bi-save"></i>
                                <span th:text="*{id} == null ? 'Guardar compra' : 'Actualizar compra'"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Librerías JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Script Select2 + carga y cálculo de precios -->
<script th:inline="javascript">
/*<![CDATA[*/
var precioUnitarioInicial = /*[[${precioUnitario}]]*/ 0;
var precioTotalInicial = /*[[${precioTotal}]]*/ 0;

$(document).ready(function() {
    $('.select2').select2({ width: '100%' });

    var precioSeleccionadoId = /*[[${compra.precioProducto != null ? compra.precioProducto.id : ''}]]*/ '';
    var precioManualValor = precioUnitarioInicial ? precioUnitarioInicial : '';

    function cargarPreciosDisponibles(precioId, precioManualVal) {
        var productoId = $('#productoSelect').val();
        var supermercadoId = $('#supermercadoSelect').val();
        var $precioSelect = $('#precioSelect');
        var $precioManual = $('#precioManual');

        $precioSelect.empty()
            .append('<option value="">Selecciona un precio</option>')
            .append('<option value="manual">Otro precio...</option>');
        $precioManual.hide().val('');
        $('#precioUnitarioHidden').val('');

        if (productoId && supermercadoId) {
            $.ajax({
                url: '/precios-producto-supermercado',
                data: { productoId, supermercadoId },
                success: function(precios) {
                    if (!precios || precios.length === 0) {
                        $precioSelect.val('manual');
                        $precioManual.show();
                        if (precioManualVal) {
                            $precioManual.val(precioManualVal);
                            $('#precioUnitarioHidden').val(precioManualVal);
                        }
                        calcularPrecioTotal();
                    } else {
                        precios.forEach(function(ps) {
                            var fecha = ps.fecha ? ' (' + ps.fecha + ')' : '';
                            $precioSelect.append(
                                '<option value="' + ps.id + '" data-precio="' + ps.precio + '">' +
                                ps.precio + '€' + fecha +
                                '</option>'
                            );
                        });

                        if (precioId) {
                            if ($precioSelect.find('option[value="' + precioId + '"]').length) {
                                $precioSelect.val(precioId);
                                $('#precioUnitarioHidden').val($("#precioSelect option:selected").data("precio"));
                            } else {
                                $precioSelect.val('manual');
                                $precioManual.show();
                                if (precioManualVal) {
                                    $precioManual.val(precioManualVal);
                                    $('#precioUnitarioHidden').val(precioManualVal);
                                }
                            }
                        }
                        calcularPrecioTotal();
                    }
                }
            });
        } else {
            $precioSelect.append('<option value="">Selecciona producto y supermercado</option>');
            calcularPrecioTotal();
        }
    }

    function calcularPrecioTotal() {
        var cantidad = parseFloat($('#cantidadInput').val()) || 0;
        var precio = 0;
        var selectedVal = $('#precioSelect').val();

        if (selectedVal === "manual") {
            precio = parseFloat($('#precioManual').val()) || 0;
            $('#precioUnitarioHidden').val(precio);
        } else if (selectedVal) {
            precio = parseFloat($("#precioSelect option:selected").data("precio")) || 0;
            $('#precioUnitarioHidden').val(precio);
        }

        var total = precio * cantidad;

        // Si la cantidad y precio dan total 0, intenta poner el precio total inicial para no perder el dato
        if (total > 0) {
            $('#precioInput').val(total.toFixed(2));
        } else if (precioTotalInicial && precioTotalInicial > 0) {
            $('#precioInput').val(precioTotalInicial);
        } else {
            $('#precioInput').val('');
        }
    }

    $('#productoSelect, #supermercadoSelect').change(function() {
        cargarPreciosDisponibles(precioSeleccionadoId, precioManualValor);
    });

    $('#precioSelect').change(function() {
        var selectedVal = $(this).val();
        if (selectedVal === "manual") {
            $('#precioManual').show();
        } else {
            $('#precioManual').hide();
        }
        calcularPrecioTotal();
    });

    $('#precioManual').on('input', calcularPrecioTotal);
    $('#cantidadInput').on('input', calcularPrecioTotal);

    // Carga inicial
    cargarPreciosDisponibles(precioSeleccionadoId, precioManualValor);
});
/*]]>*/
</script>







</body>
</html>

